name: Search Flight Deals

on:
  # Run on schedule (cron)
  schedule:
    # Run every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
    # Syntax: minute hour day month day-of-week
    # Examples:
    # - cron: '0 */4 * * *'   # Every 4 hours
    # - cron: '0 0 * * *'     # Daily at midnight UTC
    # - cron: '0 8,20 * * *'  # Twice daily at 8am and 8pm UTC

  # Allow manual trigger
  workflow_dispatch:

  # Optionally run on push (for testing)
  # push:
  #   branches: [ main ]

jobs:
  search-flights:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        month:
          - name: april
            start: "2026-04-01"
            end: "2026-04-30"
          - name: may
            start: "2026-05-01"
            end: "2026-05-31"
          - name: september
            start: "2026-09-01"
            end: "2026-09-30"
          - name: october
            start: "2026-10-01"
            end: "2026-10-31"
          - name: november
            start: "2026-11-01"
            end: "2026-11-30"

    name: Search ${{ matrix.month.name }} flights

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create .env file from secrets
      run: |
        cat > .env << EOF
        AMADEUS_API_KEY=${{ secrets.AMADEUS_API_KEY }}
        AMADEUS_API_SECRET=${{ secrets.AMADEUS_API_SECRET }}
        SMTP_SERVER=${{ secrets.SMTP_SERVER }}
        SMTP_PORT=${{ secrets.SMTP_PORT }}
        SMTP_USERNAME=${{ secrets.SMTP_USERNAME }}
        SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}
        ALERT_EMAIL=${{ secrets.ALERT_EMAIL }}
        EOF

    - name: Search ${{ matrix.month.name }} flights
      run: |
        python src/main.py --once --start-date ${{ matrix.month.start }} --end-date ${{ matrix.month.end }}

    - name: Upload search logs (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: search-logs
        path: |
          *.log
          /tmp/flight_cache/
        retention-days: 7

    - name: Notify on completion
      if: always()
      run: |
        echo "Flight search completed at $(date)"
        echo "Status: ${{ job.status }}"
